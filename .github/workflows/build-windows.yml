name: Build Windows EXE (installer)

on:
  push:
    branches: [ master ]
  workflow_dispatch:
    inputs:
      version:
        description: 'Optional version string to embed in installer'
        required: false

jobs:
  build:
    name: Build on Windows
    runs-on: windows-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt || true
          pip install pyinstaller

      - name: (Optional) Install ffmpeg
        if: ${{ env.INCLUDE_FFMPEG == 'true' }}
        run: |
          choco install ffmpeg -y || echo "ffmpeg install skipped"

      - name: Prepare version
        id: ver
        shell: bash
        run: |
          # Prefer workflow input version, then Git tag, else fallback to short commit sha
          INPUT_VER="${{ github.event.inputs.version || '' }}"
          if [ -n "$INPUT_VER" ]; then
            VERSION="$INPUT_VER"
          elif [[ "$GITHUB_REF" == refs/tags/* ]]; then
            VERSION="${GITHUB_REF#refs/tags/}"
          else
            VERSION=$(git rev-parse --short HEAD)
            VERSION="0.0.0-dev-$VERSION"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Build with PyInstaller (onedir)
        # Use bash on windows runner to allow POSIX-style line continuation
        shell: bash
        run: |
          # Ensure working dir is repo root
          cd $GITHUB_WORKSPACE

          # Dynamically include --add-data only for existing resource paths to avoid pyinstaller errors
          ADD_ARGS=()
          for d in resource public resource/subtitle_style app/components; do
            if [ -e "$d" ]; then
              echo "Including data: $d"
              ADD_ARGS+=(--add-data "$d;$d")
            else
              echo "Not found, skipping: $d"
            fi
          done

          echo "Final add-data args: ${ADD_ARGS[*]}"

          # Use --onedir to produce folder that installer can package
          pyinstaller --noconfirm --clean --name VideoCaptioner --windowed --onedir "${ADD_ARGS[@]}" main.py

      - name: List dist
        shell: bash
        run: |
          echo "dist contents:"; ls -la dist || true

      - name: Install Inno Setup (for installer)
        run: |
          choco install innosetup -y

      - name: Build Installer with Inno Setup
        shell: bash
        env:
          VIDEO_VERSION: ${{ steps.ver.outputs.version }}
        run: |
          echo "Building installer for version: $VIDEO_VERSION"
          ISCC_PATH="C:\\Program Files (x86)\\Inno Setup 6\\ISCC.exe"
          if [ ! -f "$ISCC_PATH" ]; then
            echo "ISCC not found at $ISCC_PATH"; exit 1
          fi

          # Create a temporary working folder and copy built files
          OUTDIR="$GITHUB_WORKSPACE/dist_installer"
          rm -rf "$OUTDIR" || true
          mkdir -p "$OUTDIR"
          cp -r "dist/VideoCaptioner/"* "$OUTDIR/"

          # Copy license and README if present
          if [ -f LICENSE ]; then cp LICENSE "$OUTDIR/"; fi
          if [ -f README.md ]; then cp README.md "$OUTDIR/"; fi

          # Run Inno Setup compiler (ISCC) with version define
          "$ISCC_PATH" /DMyAppVersion="$VIDEO_VERSION" build/installer.iss

          # Move produced installer into dist_installer for consistent artifact collection
          OUTPUT_EXE="VideoCaptioner-Setup-${VIDEO_VERSION}.exe"
          if [ -f "$OUTPUT_EXE" ]; then
            mv "$OUTPUT_EXE" "$OUTDIR/"
          else
            echo "Expected installer $OUTPUT_EXE not found"; ls -la || true; exit 1
          fi

      - name: Upload artifacts (installer + dist)
        uses: actions/upload-artifact@v4
        with:
          name: VideoCaptioner-windows-artifacts
          path: |
            dist/VideoCaptioner
            dist/VideoCaptioner.exe
            dist_installer/*.exe

      - name: Create GitHub Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.ver.outputs.version }}
          release_name: "VideoCaptioner ${{ steps.ver.outputs.version }}"
          body: |
            Automated build artifact for version ${{ steps.ver.outputs.version }}
          draft: false
          prerelease: false

      - name: Upload installer to release
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: dist_installer/VideoCaptioner-Setup-${{ steps.ver.outputs.version }}.exe
          asset_name: VideoCaptioner-Setup-${{ steps.ver.outputs.version }}.exe
          asset_content_type: application/octet-stream
